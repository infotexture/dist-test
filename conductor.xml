<project name="DOST" default="init" basedir=".">
  <import file="catalog-ant.xml"></import>
  <import file="ditatargets.xml"></import>
  <import file="pretargets.xml"></import>    
  
  <path id="dost.class.path">
    
    <pathelement location="${basedir}${file.separator}lib${file.separator}dost.jar"></pathelement>
  </path>
  
  <taskdef name="pipeline" classname="org.dita.dost.invoker.AntInvoker">
    <classpath refid="dost.class.path"></classpath>
  </taskdef>
  <taskdef name="config-logger" classname="org.dita.dost.log.LogConfigTask">
    <classpath refid="dost.class.path"></classpath>
  </taskdef>
  
  <taskdef name="dita-ot-echo" classname="org.dita.dost.log.DITAOTEchoTask">
    <classpath refid="dost.class.path"></classpath>
  </taskdef>
  
  <taskdef name="dita-ot-fail" classname="org.dita.dost.log.DITAOTFailTask">
    <classpath refid="dost.class.path"></classpath>
  </taskdef>  
  
  <taskdef name="dita-ot-copy" classname="org.dita.dost.util.DITAOTCopy">
    <classpath refid="dost.class.path"></classpath>
  </taskdef>
  
  <typedef name="isabsolute" classname="org.dita.dost.util.IsAbsolute">
    <classpath refid="dost.class.path"></classpath>
  </typedef>
  
  

  <property name="dita.dir" value="${basedir}"></property>
  <property name="dita.temp.dir" value="${basedir}${file.separator}temp"></property>
  <property name="output.dir" value="${basedir}${file.separator}out"></property>
  <property name="dita.extname" value="xml"></property>
  <property name="dita.script.dir" value="${dita.dir}${file.separator}xsl"></property>
  <property name="dita.resource.dir" value="${dita.dir}${file.separator}resource"></property>
  <property name="hhc.dir" value="C:\Program Files\HTML Help Workshop"></property>
  <property environment="env"></property>
  <property name="dita.empty" value=""></property>
  
  
  <target name="init">
    <dita-ot-fail id="DOTA001F">
      <condition>
        <and>
          <not>
            <equals arg1="${transtype}" arg2="xhtml" casesensitive="false"></equals>
          </not>
          <not>
            <equals arg1="${transtype}" arg2="eclipsehelp" casesensitive="false"></equals>
          </not>
          <not>
            <equals arg1="${transtype}" arg2="javahelp" casesensitive="false"></equals>
          </not>
          <not>
            <equals arg1="${transtype}" arg2="htmlhelp" casesensitive="false"></equals>
          </not>
          <not>
            <equals arg1="${transtype}" arg2="pdf" casesensitive="false"></equals>
          </not>
          <not>
            <equals arg1="${transtype}" arg2="docbook" casesensitive="false"></equals>
          </not>
          <not>
            <equals arg1="${transtype}" arg2="eclipsecontent" casesensitive="false"></equals>
          </not>
          <not>
            <equals arg1="${transtype}" arg2="troff" casesensitive="false"></equals>
          </not>
          <not>
            <equals arg1="${transtype}" arg2="wordrtf" casesensitive="false"></equals>
          </not>
          
        </and>
      </condition>
    </dita-ot-fail>
    <antcall target="dita2${transtype}"></antcall>
  </target>

  <target name="use-init">
    <available classname="com.icl.saxon.StyleSheet" property="hasSaxon"></available>
    <available classname="org.apache.fop.tools.anttasks.Fop" property="hasFOP"></available>
    <available file="${hhc.dir}\hhc.exe" property="HTMLHelpCompiler" value="${hhc.dir}\hhc.exe"></available>
  </target>

  
  <target name="check-arg" depends="use-init" description="Validate and init input arguments">
    
    <dita-ot-fail id="DOTA002F">
      <condition>
        <and>
        <or>
          <not>
            <isset property="args.input"></isset>
          </not>
          <and>
            <isset property="args.input"></isset>
            <not><available file="${args.input}" type="file"></available></not>
          </and>
        </or>
        <or>
          <not>
            <isset property="dita.input"></isset>
          </not>
          <not>
            <isset property="dita.input.dirname"></isset>
          </not>
          <and>
            <isset property="dita.input"></isset>
            <isset property="dita.input.dirname"></isset>
            <not><available file="${dita.input}" filepath="${dita.input.dirname}" type="file"></available></not>
          </and>
        </or>
        </and>
      </condition>
    </dita-ot-fail>
    
    <dita-ot-fail id="DOTA003F" params="%1=${args.xsl}">
      <condition>
        <and>
          <isset property="args.xsl"></isset>
          <not><available file="${args.xsl}" type="file"></available></not>
        </and>
      </condition>
    </dita-ot-fail>
    
    <dita-ot-fail id="DOTA004F" params="%1=${dita.extname}">
      <condition>
        <not>
        <or>
          <contains string="${dita.extname}" substring="dita"></contains>
          <contains string="${dita.extname}" substring="xml"></contains>
        </or>
        </not>
      </condition>
    </dita-ot-fail>
    
    
    
    
    <condition property="msg.deprecate">
      <and>
        <not><isset property="args.input"></isset></not>
        <isset property="dita.input"></isset>
        <isset property="dita.input.dirname"></isset>
      </and>
    </condition>
    
    <condition property="args.input" value="${dita.input.dirname}${file.separator}${dita.input}">
      <not><isset property="args.input"></isset></not>
    </condition>
    
    <condition property="dita.ext" value=".xml">
      <and>
        <isset property="dita.extname"></isset>
        <contains string="${dita.extname}" substring="xml"></contains>
      </and>
    </condition>    
    <condition property="dita.ext" value=".dita">
      <and>
        <isset property="dita.extname"></isset>
        <contains string="${dita.extname}" substring="dita"></contains>
      </and>
    </condition>
    
    
    <condition property="out.ext" value=".${args.outext}">
      <and>
        <isset property="args.outext"></isset>
        <not>
          <contains string="${args.outext}" substring="."></contains>
        </not>
      </and>
    </condition>    
    <condition property="out.ext" value="${args.outext}">
      <and>
        <isset property="args.outext"></isset>        
        <contains string="${args.outext}" substring="."></contains>
      </and>
    </condition>
    
    
    <condition property="fo.img.ext" value=".${args.fo.img.ext}">
      <and>
        <isset property="args.fo.img.ext"></isset>
        <not>
          <contains string="${args.fo.img.ext}" substring="."></contains>
        </not>
      </and>
    </condition>
    <condition property="fo.img.ext" value="${args.fo.img.ext}">
      <and>
        <isset property="args.fo.img.ext"></isset>        
        <contains string="${args.fo.img.ext}" substring="."></contains>
      </and>
    </condition>
    
    <condition property="clean_temp">
      <and>
        <isset property="clean.temp"></isset>
        <equals arg1="${clean.temp}" arg2="no" casesensitive="false"></equals> 
      </and>
    </condition>
    
    <basename property="dita.input.filename" file="${args.input}"></basename>    
    <basename property="dita.map.filename.root" file="${dita.input.filename}" suffix=".ditamap"></basename>
    <basename property="dita.topic.filename.root" file="${dita.input.filename}" suffix="${dita.ext}"></basename>
    

    
    <mkdir dir="${output.dir}"></mkdir>
    <mkdir dir="${dita.temp.dir}"></mkdir>

    
    <condition property="user.csspath.url">
      <or>
        <contains string="${args.csspath}" substring="http://"></contains>
        <contains string="${args.csspath}" substring="https://"></contains>
      </or>
    </condition>    
    <condition property="args.csspath.absolute">
      <isabsolute path="${args.csspath}"></isabsolute>
    </condition>    
    
    <condition property="user.csspath" value="">
      <or>
        <not><isset property="args.csspath"></isset></not>
        <isset property="args.csspath.absolute"></isset>
      </or>
    </condition>
    <condition property="user.csspath" value="${args.csspath}/">
        <not><isset property="user.csspath"></isset></not>
    </condition>
    <available file="${args.css}" property="args.css.present" type="file"></available>
    <basename property="args.css.file.temp" file="${args.css}"></basename>
    <condition property="args.css.file" value="${args.css.file.temp}">
        <isset property="args.css.present"></isset>
    </condition>
    
    
    <condition property="args.logdir" value="${output.dir}">
        <not><isset property="args.logdir"></isset></not>
    </condition>
    
    <condition property="index.ext.param.encoding" value="">
        <not><isset property="args.dita.locale"></isset></not>
    </condition>
    
    <condition property="index.ext.param.encoding" value="encoding=${args.dita.locale}">
        <not><isset property="index.ext.param.encoding"></isset></not>
    </condition>    
    
    <condition property="xslt.parser" value="SAXON">
        <isset property="hasSaxon"></isset>
    </condition>
    <condition property="xslt.parser" value="XALAN">
        <not><isset property="xslt.parser"></isset></not>
    </condition>    
    
    <echo>*****************************************************************</echo>
    <echo>* input = ${args.input}</echo>
    <echo>* transtype = ${transtype}</echo>
    <echo>* tempdir = ${dita.temp.dir}</echo>
    <echo>* outputdir = ${output.dir}</echo>    
    <echo>* extname = ${dita.ext}</echo>
    <echo>* clean.temp = ${clean.temp}</echo>
    <echo>* xslt.parser = ${xslt.parser}</echo>
    <echo>*****************************************************************</echo>
  </target>
  
  <target name="start-process" description="Processing started"></target>
  
  <target name="output-deprecated-msg" if="msg.deprecate">        
    <dita-ot-echo id="DOTA005W"></dita-ot-echo>
  </target>
  
  <target name="output-css-warn-message" if="args.csspath.absolute">
    <dita-ot-echo id="DOTA006W"></dita-ot-echo>
  </target>
  
  <target name="init-logger" description="Init log directory and file name">
    <config-logger></config-logger>
  </target>
  
  
  <target name="dita-preprocess" depends="start-process, init-logger, check-arg, output-deprecated-msg, output-css-warn-message, preprocess"></target>
  
  
  
  <target name="dita2wordrtf" depends="dita-preprocess, map2wordrtf, topic2wordrtf"></target>
  <target name="topic2wordrtf" if="noMap" depends="dita-preprocess">
    <antcall target="dita.topic.rtf">
      <param name="input" value="${dita.temp.dir}${file.separator}${user.input.file}"></param>
      <param name="output" value="${dita.map.output.dir}${file.separator}${dita.topic.filename.root}.rtf"></param>
    </antcall>
  </target>
  <target name="map2wordrtf" unless="noMap" depends="dita-preprocess">
    <antcall target="dita.map.rtf">
      <param name="input" value="${dita.temp.dir}${file.separator}${user.input.file}"></param>
      <param name="output" value="${dita.map.output.dir}${file.separator}${dita.map.filename.root}.rtf"></param>
    </antcall>
  </target>
  
  <target name="dita2pdf" depends="dita-preprocess, map2pdf, topic2pdf"></target>   
  
  <target name="topic2pdf" if="noMap" depends="dita-preprocess">
    <antcall target="dita.topic.fo">
      <param name="input" value="${dita.temp.dir}${file.separator}${user.input.file}"></param>
      <param name="output" value="${dita.map.output.dir}${file.separator}${dita.topic.filename.root}.fo"></param>
    </antcall>
	<antcall target="dita.fo2pdf">
      <param name="input" value="${dita.map.output.dir}${file.separator}${dita.topic.filename.root}.fo"></param>
      <param name="output" value="${dita.map.output.dir}${file.separator}${dita.topic.filename.root}.pdf"></param>
    </antcall>
  </target>
  
  <target name="map2pdf" unless="noMap" depends="dita-preprocess">
    <antcall target="dita.map.fo">
      <param name="input" value="${dita.temp.dir}${file.separator}${user.input.file}"></param>
      <param name="output" value="${dita.map.output.dir}${file.separator}${dita.map.filename.root}.fo"></param>
    </antcall>
    <antcall target="dita.fo2pdf">
      <param name="input" value="${dita.map.output.dir}${file.separator}${dita.map.filename.root}.fo"></param>
      <param name="output" value="${dita.map.output.dir}${file.separator}${dita.map.filename.root}.pdf"></param>
    </antcall>
  </target>
  			
  <target name="dita2docbook" depends="dita-preprocess, topic2docbook, map2docbook"></target>
  
  <target name="topic2docbook" if="noMap" depends="dita-preprocess">
    <antcall target="dita.topic.docbook">
      <param name="inputFile" value="${dita.temp.dir}${file.separator}${user.input.file}"></param>
      <param name="outputFile" value="${dita.map.output.dir}${file.separator}${dita.topic.filename.root}.xml"></param>
    </antcall>
  </target>
  
  <target name="map2docbook" unless="noMap" depends="dita-preprocess">
    <antcall target="dita.map.docbook">
      <param name="mapRoot" value="${dita.map.filename.root}"></param>
      <param name="inputMap" value="${user.input.file}"></param>
      <param name="inputDir" value="${dita.temp.dir}"></param>
      <param name="outputDir" value="${dita.map.output.dir}"></param>
    </antcall>
  </target>
  
  <target name="dita2xhtml" depends="dita-preprocess, map2xhtml">
    <antcall target="dita.topics.xhtml"></antcall>
  </target>
  
  <target name="map2xhtml" unless="noMap">
    <antcall target="dita.map.xhtml"></antcall>
  </target>
  
  <target name="dita2javahelp" unless="noMap" depends="dita-preprocess">
    <condition property="args.javahelp.helpset" value="${dita.resource.dir}${file.separator}helpset.hs">
      <not>
        <isset property="args.javahelp.helpset"></isset>
      </not>
    </condition>
    <antcall target="dita.topics.javahelp"></antcall>
    <antcall target="dita.map.javahelp"></antcall>

    <antcall target="compile.Java.Help">
      <param name="outputDir" value="${dita.map.output.dir}"></param>
    </antcall>
  </target>
  
  <target name="dita2eclipsehelp" unless="noMap" depends="dita-preprocess">

    <antcall target="dita.topics.eclipse"></antcall>
    <antcall target="dita.map.eclipse"></antcall>

  </target>
  
  <target name="dita2eclipsecontent" unless="noMap" depends="dita-preprocess">

    <antcall target="dita.topics.eclipse.content"></antcall>
    <antcall target="dita.map.eclipse.content"></antcall>

  </target>
  
  <target name="dita2htmlhelp" unless="noMap" depends="dita-preprocess">
    <antcall target="dita.map.htmlhelp"></antcall>
    <antcall target="dita.topics.htmlhelp"></antcall>
    <antcall target="compile.HTML.Help">
      <param name="projectFile" value="${dita.map.output.dir}${file.separator}${dita.map.filename.root}.hhp"></param>
    </antcall>
  </target>

  <target name="dita2troff" depends="dita-preprocess">
    <antcall target="dita.topic.troff">
      <param name="inputDir" value="${dita.temp.dir}"></param>
      <param name="inputFile" value="${user.input.file}"></param>
      <param name="outputDir" value="${dita.map.output.dir}"></param>
      <param name="outputFileRoot" value="${dita.topic.filename.root}"></param>
    </antcall>
  </target>
  
  
</project>