<project name="pre-targets"  basedir=".">
  <!-- (c) Copyright IBM Corp. 2004, 2005 All Rights Reserved. -->
  <!-- preprocess target begin -->
  <target name="preprocess" depends="clean-temp, gen-list,copy-image,copy-html,copy-flag,debug-filter,move-index-entries,conref,mappull,maplink,move-links,topicpull">
    
  </target>
  <!-- preprocess target end-->

  <!-- parameters 
    dita.input.dirname      required
    dita.input              required
    dita.input.valfile      optional
    dita.temp.dir           required
    dita.extname            required
  -->
  
  <!-- preprocess modules begin -->
  <target name="clean-temp" unless="clean_temp" description="delete temp directory">
    <delete dir="${dita.temp.dir}"/>
  </target>  
  
  <target name="gen-list">
    <pipeline message="Generate list."
      module="GenMapAndTopicList"
      basedir="${dita.input.dirname}"
      inputmap="${dita.input}"
      tempdir="${dita.temp.dir}"
      extparam="ditadir=${basedir}"/>
	
	<property file="${dita.temp.dir}${file.separator}dita.list"/>
  
	<condition property="noConref">
		<equals arg1="${conreflist}" arg2=""/>
	</condition>
	<condition property="noMap">
		<equals arg1="${fullditamaplist}" arg2=""/>
	</condition>
	<condition property="noTopicpull">
		<equals arg1="${hrefditatopiclist}" arg2=""/>
    </condition>
	<condition property="noImagelist">
		<equals arg1="${imagelist}" arg2=""/>
	</condition>
  <condition property="noHtmllist">
		<equals arg1="${htmllist}" arg2=""/>
	</condition>
  
  </target>
  
  <target name="debug-filter" depends="gen-list,debug,debug-and-filter"/>
  
  <target name="debug" unless="dita.input.valfile">
    <echo message="debug"/>
    <pipeline message="Debug and filtering."
		module="DebugAndFilter"
    basedir="${dita.input.dirname}"
    tempdir="${dita.temp.dir}"/>
  </target>
  
  <target name="debug-and-filter" if="dita.input.valfile">
    <echo message="debug and filter"/>
    <pipeline message="Debug and filtering."
		module="DebugAndFilter"
		extparam="ditaval=${dita.input.valfile}"
    basedir="${dita.input.dirname}"
    tempdir="${dita.temp.dir}"/>
  </target>
  
  <target name="move-index-entries" unless="noMap" depends="debug-filter">
  	<pipeline message="Move index entries."
		module="MoveIndex"
		inputmap="${dita.input}"
    tempdir="${dita.temp.dir}"
	/>
  </target>
  
  <target name="conref" unless="noConref" depends="debug-filter">
  	<echo message="in conref"/>
  	<xslt processor="trax"
		basedir="${dita.temp.dir}"
		destdir="${dita.temp.dir}"
		includes="${conreflist}"
		style="${dita.script.dir}${file.separator}preprocess${file.separator}conref.xsl">
	<mapper type="glob" from="*" to="*.cnrf"/>
        <param name="DITAEXT" expression="${dita.extname}"/>
    </xslt>
	
	<move todir="${dita.temp.dir}">
		<fileset dir="${dita.temp.dir}" includes="**/*.cnrf"/>
		<mapper type="glob" from="*.cnrf" to="*"/>
	</move>
  </target>
    
  <target name="mappull" unless="noMap" depends="move-index-entries">
  	<dirname property="mappull.workdir" file="${dita.temp.dir}/${dita.input}"/>

    <xslt processor="trax"
      in="${dita.temp.dir}${file.separator}${dita.input}"
      out="${mappull.workdir}${file.separator}${dita.map.filename.root}.ditamap.pull"
      style="${dita.script.dir}${file.separator}preprocess${file.separator}mappull.xsl">
        <param name="DITAEXT" expression="${dita.extname}" if="dita.extname"/>
    </xslt>
	  
    <copy overwrite="true" todir="${dita.temp.dir}">
      <fileset dir="${dita.temp.dir}" includes="**/*.ditamap.pull"/>
      <mapper type="glob" from="*.ditamap.pull" to="*.ditamap"/>
    </copy>
  </target>
  
  <target name="maplink" unless="noMap" depends="mappull">
  	<dirname property="maplink.workdir" file="${dita.temp.dir}/${dita.input}"/>
  	<xslt processor="trax"
		in="${dita.temp.dir}${file.separator}${dita.input}"
		out="${maplink.workdir}${file.separator}maplinks.unordered"
		style="${dita.script.dir}${file.separator}preprocess${file.separator}maplink.xsl">
        <param name="DITAEXT" expression="${dita.extname}" if="dita.extname"/>
        <param name="INPUTMAP" expression="${dita.input}"/>
    </xslt>
	
  </target>
  
  <target name="move-links" unless="noMap" depends="maplink">
      <pipeline message="Move links."
		module="MoveLinks"
		extparam="maplinks=${maplink.workdir}${file.separator}maplinks.unordered"
		inputmap="${dita.input}"
    tempdir="${dita.temp.dir}"/>
  </target>
  
  <target name="topicpull" depends="debug-filter">
    <xslt processor="trax"
		basedir="${dita.temp.dir}"
		destdir="${dita.temp.dir}"
		includes="${fullditatopiclist}"
		extension="${dita.extname}.pull"
		style="${dita.script.dir}${file.separator}preprocess${file.separator}topicpull.xsl">
        <param name="DITAEXT" expression="${dita.extname}" if="dita.extname"/>
    </xslt>
	<move todir="${dita.temp.dir}">
		<fileset dir="${dita.temp.dir}" includes="**/*${dita.extname}.pull"/>
		<mapper type="glob" from="*${dita.extname}.pull" to="*${dita.extname}"/>
    </move>
  </target>

  
  <target name="copy-image" unless="noImagelist">
    <copy todir="${output.dir}">
        <fileset dir="${dita.input.dirname}" includes="${imagelist}"/>
    </copy>
  </target>
  
  <target name="copy-flag" if="dita.input.valfile">
    <copy todir="${dita.map.output.dir}">
      <fileset dir="${dita.resource.dir}" includes="delta.gif,deltaend.gif"/>
    </copy>
  </target>
  
  <target name="copy-html" unless="noHtmllist">
    <copy todir="${output.dir}">
        <fileset dir="${dita.input.dirname}" includes="${htmllist}"></fileset>
    </copy>
  </target>
  
  <!-- preprocess modules end -->
</project>